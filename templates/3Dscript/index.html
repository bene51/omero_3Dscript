<html>
<head>
  <meta charset="UTF-8">
  <title>3DScript</title>
  <script src="{% static '3Dscript/3rdparty/jquery-ui-1.12.1/external/jquery/jquery.js' %}"></script>
  <script src="{% static '3Dscript/3rdparty/jquery-ui-1.12.1/jquery-ui.min.js' %}"></script>
  <link rel="stylesheet" href="{% static '3Dscript/3rdparty/jquery-ui-1.12.1/jquery-ui.css' %}">
  <link rel="stylesheet" href="{% static '3Dscript/css/3Dscript.css' %}">
  <link rel="stylesheet" href="{% static '3Dscript/css/dialogs.css' %}">
  <script type="text/javascript">
    function resizeit() {
      var targetVideoWidth = $("#videoContainer")[0].clientWidth;
      var targetVideoHeight = $("#videoContainer")[0].clientHeight;
      console.log("tgtw = " + targetVideoWidth + " tgth = " + targetVideoHeight);
      var targetAspect = targetVideoWidth / targetVideoHeight;
      console.debug("targetAspect = "  + targetAspect);

      var previews = $("#preview");
      if(previews.length > 0) {
        var preview = previews[0];
        if(preview.tagName == "VIDEO") {
          preview.addEventListener("loadedmetadata", function(e) {
            var videoWidth = this.videoWidth;
            var videoHeight = this.videoHeight;
            var aspect = videoWidth / videoHeight;
            if(aspect > targetAspect) {
              // keep width and let hight be adjusted automatically
              preview.width = targetVideoWidth;
            }
            else {
              // keep height and let width be adjusted automatically
              preview.height = targetVideoHeight;
            }
            console.log("videoWidth = " + videoWidth);
            console.log("videoHeight = " + videoHeight);

            console.log("videoWidth/videoHeight = " + (videoWidth / videoHeight));
          });
        }
        else if(preview.tagName == "IMG") {
          preview.onload = function() {
            console.debug(previews);
            var videoWidth = preview.clientWidth;
            console.debug("videoWidth = "  + videoWidth);
            var videoHeight = preview.clientHeight;
            console.debug("videoHeight = "  + videoHeight);
            var aspect = videoWidth / videoHeight;
            console.debug("aspect = " + aspect);
            if(aspect > targetAspect) {
              // keep width and let hight be adjusted automatically
              preview.width = targetVideoWidth;
              console.debug("targetVideoWidth = " + targetVideoWidth);
            }
            else {
              // keep height and let width be adjusted automatically
              preview.height = targetVideoHeight;
            }
          };
        }
      }
    }

    function startRendering() {
      enableRenderingButton(false);
      $("#backtrace")[0].innerHTML = "";
      accordion.accordion("refresh");
      accordion.accordion("option", "active", false);
      var imageId = $("#imageId")[0].value;
      var script = $("#script")[0].value;
      var targetWidth = $("#tgtWidth")[0].value;
      var targetHeight = $("#tgtHeight")[0].value;
      var bbVisible = $("#bbswitch")[0].checked;
      var bbColor = $("#bbcolor")[0].value;
      var bbLinewidth = $("#bblinewidth")[0].value;
      var sbVisible = $("#sbswitch")[0].checked;
      var sbColor = $("#sbcolor")[0].value;
      var sbLinewidth = $("#sblinewidth")[0].value;
      var sbPosition = $("#sbposition")[0].value;
      var sbOffset = $("#sboffset")[0].value;
      var sbLength = $("#sblength")[0].value;
      console.debug("startRendering");
      $.ajax({
        url: '/omero_3dscript/startRendering',
        data: {
          imageId: imageId,
          script: script,
          targetWidth: targetWidth,
          targetHeight: targetHeight,
          bbVisible: bbVisible,
          bbColor: bbColor,
          bbLinewidth: bbLinewidth,
          sbVisible: sbVisible,
          sbColor: sbColor,
          sbLinewidth: sbLinewidth,
          sbPosition: sbPosition,
          sbOffset: sbOffset,
          sbLength: sbLength
        },
        dataType: 'json',
        success: function(data) {
          if(data.error) {
            console.debug("error startRendering");
            setStateAndProgress('ERROR: ' + data.error.trim(), -1, data.stacktrace);
            enableRenderingButton(true);
          }
          else {
            console.debug("success startRendering");
            var basename = data.basename;
            $('#bar').width(1 + '%');
            updateState(basename);
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          console.debug("error in startRendering " + thrownError);
        }
      });
    }

    function setStateAndProgress(state, progress, stacktrace=null) {
      var pbar = $('#bar');
      var label = $('#barlabel');
      if(progress >= 0)
        // pbar.width(progress + '%');
        pbar.stop().animate({"width": progress + '%'}, 100); // .queue(function(){});
      if(state != null) {
        label[0].innerHTML = state;
        if(state.startsWith('ERROR')) {
          pbar.css({"background-color":"red"});
          label.css({"color":"black"});
          if(stacktrace)
            $("#backtrace")[0].innerHTML = "<pre>" + stacktrace + "</pre>";
          accordion.accordion("refresh");
          accordion.accordion("option", "active", 0);
        }
        else {
          pbar.css({"background-color":"#4caf50"});
          label.css({"color":"white"});
          $("#backtrace")[0].innerHTML = "";
          accordion.accordion("refresh");
          accordion.accordion("option", "active", false);
        }
      }
    }

    function enableRenderingButton(state) {
      $('#startRendering').prop("disabled", !state);
    }

    function updateState(basename) {
      setTimeout(function myTimer() {
        console.debug("updateState");
        $.ajax({
          url: '/omero_3dscript/getStateAndProgress',
          data: {
            basename: basename
          },
          dataType: 'json',
          success: function(data) {
            if(data.state.startsWith('ERROR')) {
              console.debug("error updateState");
              setStateAndProgress('ERROR', 100 * data.progress, data.stacktrace);
              enableRenderingButton(true);
            }
            else if (data.state.startsWith('FINISHED')) {
              console.debug("finished updateState");
              createAnnotation(basename);
              enableRenderingButton(true);
            }
            else {
              console.debug("before setStateAndProgress");
              setStateAndProgress(data.state, 100 * data.progress);
              console.debug("about to call updateState again");
              updateState(basename);
            }
          },
          error: function(xhr, ajaxOptions, thrownError) {
            console.debug("error in updateState " + thrownError);
          }
        });
      }, 500);
    }

    function createAnnotation(basename) {
      setStateAndProgress('CREATE ATTACHMENT', 95);
      $.ajax({
          url: '/omero_3dscript/createAnnotation',
          data: {
            basename: basename,
            imageId: $("#imageId")[0].value
          },
          dataType: 'json',
          success: function(data) {
            if(data.error) {
              setStateAndProgress('ERROR: ' + data.error.trim(), -1);
              enableRenderingButton(true);
            }
            else {
              annotationId = data.annotationId;
              console.debug('annotationId = ' + annotationId);
              if(data.isVideo) {
                $('#videoContainer')[0].innerHTML = `
    <video id="preview" style="margin-left: auto; margin-right: auto; display: block; position: relative; top: 50%; transform: translateY(-50%);" controls>
      <source src="/webclient/annotation/${annotationId}" type="video/mp4">
      Your browser doesn't support this video.
    </video>`.trim();
              }
              else {
                $('#videoContainer')[0].innerHTML = `
    <img id="preview" style="margin-left: auto; margin-right: auto; display: block; position: relative; top: 50%; transform: translateY(-50%);" src="/webclient/annotation/${annotationId}" type="image/png">
    </img>`.trim();
              }
              resizeit();
              setStateAndProgress('FINISHED', 100);
            }
          }
      });
    }

    $(function() {
      var dialog, form,
      tgtWidth = $("#tgtWidth"),
      tgtHeight = $("#tgtHeight"),
      bbswitch = $("#bbswitch"),
      bbcolor = $("#bbcolor"),
      bblinewidth = $("#bblinewidth"),
      sbswitch = $("#sbswitch"),
      sbcolor = $("#sbcolor"),
      sblinewidth = $("#sblinewidth"),
      sblength = $("#sblength"),

      allFields = $( [] ).
        add(tgtWidth).
        add(tgtHeight).
        add(bbswitch).
        add(bbcolor).
        add(bblinewidth).
        add(sbswitch).
        add(sbcolor).
        add(sblinewidth).
        add(sblength);
      tips = $( ".validateTips" );

      function updateTips( t ) {
        tips
          .text( t )
          .addClass( "ui-state-highlight" );
        setTimeout(function() {
          tips.removeClass( "ui-state-highlight", 1500 );
        }, 500 );
      }

      function checkNumber(o, n, min) {
        var v = 0;
        var valid = true;
        try {
          v = parseFloat(o.val());
        } catch(error) {
          valid = false;
        }
        valid = valid && v >= min;

        if(!valid) {
          o.addClass("ui-state-error");
          updateTips(n + " must be a number >= " + min);
        }
        return valid;
      }

      function checkInteger(o, n, min) {
        var v = 0;
        var valid = true;
        try {
          v = parseInt(o.val());
        } catch(error) {
          valid = false;
        }
        valid = valid && v >= min;

        if(!valid) {
          o.addClass("ui-state-error");
          updateTips(n + " must be a whole number >= " + min);
        }
        return valid;
      }

      function verify() {
        var valid = true;
        allFields.removeClass( "ui-state-error" );

        valid = valid && checkInteger(tgtWidth, "Output width", 50);
        valid = valid && checkInteger(tgtHeight, "Output height", 50);
        valid = valid && checkNumber(bblinewidth, "Bounding box width", 0);
        valid = valid && checkNumber(sblinewidth, "Scalebar width", 0);
        valid = valid && checkNumber(sblength, "Scalebar length", 0);

        if(valid)
          dialog.dialog("close");

        return valid;
      }

      function onresize() {
        left = ($(window).width() - 600) / 2.0;
        // devide the left space into 5 parts,
        // 4 will be covered by the logo, the 5th
        // is gap
        gap = left / 5.0;
        logow = gap * 4;
        if(logow > 150)
          logow = 150;
        if(logow < 50)
          logow = 0;
        $("#logo").width(logow + 'px');
        $("#logo").height(logow + 'px');
        $("#header").css({"padding-left": left + "px"});
      }

      dialog = $( "#dialog-settings" ).dialog({
        autoOpen: false,
        height: 'auto',
        width: 'auto',
        modal: true,
        show: {
          effect: "fade",
          duration: 500
        },
        hide: {
          effect: "fade",
          duration: 500
        },
        buttons: {
          "Close": verify,
          Cancel: function() {
            form[ 0 ].reset();
            dialog.dialog( "close" );
          }
        },
        close: function() {
          updateTips("");
          allFields.removeClass( "ui-state-error" );
        },
        position: {
          my: "center",
          at: "center",
          of: window
        }
      });

      form = dialog.find("form").on("submit", function(event) {
        event.preventDefault();
        verify();
      });

      $("#settings").on( "click", function() {
        dialog.dialog( "open" );
      });

      accordion = $("#accordion").accordion({
        collapsible: true,
        active: false,
        animate: 200,
//        icons: {
//          "header": false, // "ui-icon-triangle-1-e",
//          "activeHeader": false //"ui-icon-triangle-1-s"
//        }
      });

      $(window).resize(function() {
        onresize();
      });

      $(window).scroll(function() {
        et = $("#logo").offset().top;
        wt = $(window).scrollTop();
        absY = et - wt;
        if(wt > 65) {
          $("#logo").css({'top': wt + 5});
        }
        else {
          $("#logo").css({'top': 60});
        }
      });

      onresize();
    });

    $(function() {
      var dialog, form,
      imageId = $("#imageId"),

      allFields = $( [] ).
        add(imageId);
      tips = $( ".validateTipsNewImage" );

      function updateTips( t ) {
        tips
          .text( t )
          .addClass( "ui-state-highlight" );
        setTimeout(function() {
          tips.removeClass( "ui-state-highlight", 1500 );
        }, 500 );
      }

      function checkInteger(o, n, min) {
        var v = 0;
        var valid = true;
        try {
          v = parseInt(o.val());
        } catch(error) {
          valid = false;
        }
        valid = valid && v >= min;

        if(!valid) {
          o.addClass("ui-state-error");
          updateTips(n + " must be a whole number >= " + min);
        }
        return valid;
      }

      function verify() {
        allFields.removeClass( "ui-state-error" );

        var valid = checkInteger(imageId, "Image ID", 0);
        if(!valid)
          return false;

	//TODO set title (name of image)
        $.ajax({
          url: '/omero_3dscript/getName',
          data: {
            image: imageId.val()
          },
          async: false,
          dataType: 'json',
          success: function(data) {
            if(data.error) {
              console.debug("error in verify: " + data.error);
              updateTips(data.error);
              valid = false;
            }
            else {
              console.debug("success in verify");
              $('#headertxt')[0].innerHTML = data.name;
            }
          },
          error: function(xhr, ajaxOptions, thrownError) {
            console.debug("error in startRendering " + thrownError);
          }
        });

        if(!valid)
          return false;

        dialog.dialog("close");
        return true;
      }

      dialog = $( "#dialog-newimage" ).dialog({
        autoOpen: false,
        height: 'auto',
        width: 'auto',
        modal: true,
        show: {
          effect: "fade",
          duration: 500
        },
        hide: {
          effect: "fade",
          duration: 500
        },
        buttons: {
          "Close": verify,
          Cancel: function() {
            form[ 0 ].reset();
            dialog.dialog( "close" );
          }
        },
        close: function() {
          updateTips("");
          allFields.removeClass( "ui-state-error" );
        },
        position: {
          my: "center",
          at: "center",
          of: window
        }
      });

      $("#imagebutton").on( "click", function() {
        dialog.dialog( "open" );
      });

      form = dialog.find("form").on("submit", function(event) {
        event.preventDefault();
        verify();
      });

      if($("#imageId")[0].value < 0) {
        $("#imageId")[0].value = '';
        dialog.dialog( "open" );
      }
    });

  </script>
</head>
<body>
  <img src="{% static '3Dscript/images/3DscriptLogo.png' %}" id="logo"></img>
  <div id="header">
    <span id="headertxt" style="line-height: 20px; height: 30px;min-width: 5px;">{{ image_name }}</span>
    <button id="imagebutton" style="margin-left: 5px; width: 30px; height: 30px; background: url({% static '3Dscript/images/edit-button.png' %}) center center no-repeat; background-size: contain; position: relative; top: -2px; line-height: 20px; vertical-align: middle; display: inline-block; border: none;"></button>
  </div>
  <div id="videoContainer">
    {% if annotationId %}
    <video id="preview" controls>
      <source src="/webclient/annotation/{{annotationId}}" type="video/mp4">
      Your browser doesn't support this video.
    </video>
    {% endif %}
  </div>

  <div id="accordion">
    <div id="progress">
      <div id="bar"></div>
      <div id="barlabel"> </div>
    </div>
    <div id="backtrace"></div>
  </div>

  <div style="width:600px; margin-left: auto; margin-right: auto;">
    {% spaceless %}
    <textarea id="script" name="script">{% if s %}{{ s }}{% else %}
At frame 0 zoom by a factor of 0.9
From frame 0 to frame 200 rotate by 360 degrees horizontally
{% endif %}</textarea>
    {% endspaceless %}
  <div id="buttons">
    <button name="startRendering" id="startRendering" value="" onclick="startRendering()">Render</button>
    <button name="settings" id="settings" value="">Settings</button>
  </div>

  <div id="footer">
    &copy;Benjamin Schmid, Optical Imaging Centre Erlangen, University of Erlangen-Nuremberg
  </div>
</div>


<div id="dialog-newimage" title="New image">
  <p class="validateTipsNewImage"> </p>
  <form>
    <label for="imageId">New image ID</label>
    <input type="number" name="imageId" id="imageId" value="{{imageId}}" class="leftmargin number ui-widget-content ui-corner-all">
  </form>
</div>

<div id="dialog-settings" title="Settings">
  <p class="validateTips"> </p>

  <form>
    <fieldset>
      <legend>Output Size</legend>
      <input type="number" name="tgtWidth" id="tgtWidth" value="600" class="number ui-widget-content ui-corner-all">
      <span class="leftmargin rightmargin">x</span>
      <input type="number" name="tgtHeight" id="tgtHeight" value="450" class="number ui-widget-content ui-corner-all"><br>
    </fieldset>
    <fieldset>
      <legend>Bounding Box</legend>
      <input type="checkbox" name="bbswitch" id="bbswitch" value="BoundingBox" checked>Visible
      <label for="bbcolor" class="leftmargin">Color</label>
      <input type="color" id="bbcolor" name="bbcolor" value="#aaaaaa" style="vertical-align: bottom;" class="ui-widget-content ui-corner-all">
      <label class="leftmargin" for="bblinewidth">Line width</label>
      <input type="number" name="bblinewidth" id="bblinewidth" value="1.0" min="0.0" step="0.5" class="number ui-widget-content ui-corner-all">
    </fieldset>
    <fieldset>
      <legend>Scalebar</legend>
      <input type="checkbox" name="sbswitch" id="sbswitch" value="ScaleBar" checked>Visible
      <label for="sbcolor" class="leftmargin">Color</label>
      <input type="color" id="sbcolor" name="sbcolor" value="#ffffff" style="vertical-align: bottom;" class="ui-widget-content ui-corner-all">
      <label class="leftmargin" for="sblinewidth">Line width</label>
      <input type="number" name="sblinewidth" id="sblinewidth" value="1.0" min="0.0" step="0.5" class="number ui-widget-content ui-corner-all">
<p>
      <label class="leftmargin" for="sblength">Length</label>
      <input type="number" name="sblength" id="sblength" value="100" min="0.0" step="0.1" class="number ui-widget-content ui-corner-all">
      <select name="sbposition" id="sbposition" class="leftmargin">
        <option>object - lower left front</option>
        <option>object - lower right front</option>
        <option>object - upper left front</option>
        <option>object - upper right front</option>
        <option>object - lower left back</option>
        <option>object - lower right back</option>
        <option>object - upper left back</option>
        <option>object - upper right back</option>
        <option selected>view - lower left</option>
        <option>view - lower right</option>
        <option>view - upper left</option>
        <option>view - upper right</option>
      </select>
      <label for="sboffset" class="leftmargin">Offset</label>
      <input type="number" name="sboffset" id="sboffset" value="10" min="0" class="number ui-widget-content ui-corner-all">
</p>
      <!--input type="password" name="password" id="password" value="xxxxxxx" class="text ui-widget-content ui-corner-all"-->
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>

</body>
</html>
